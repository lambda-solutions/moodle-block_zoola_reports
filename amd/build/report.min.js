define(["core/log","jquery","require","core/notification","core/ajax"],function(a,b,c,d,e){var f=function(a,c,f){function g(a){var c=a.message;c.indexOf("QueryExecutionTooManyRowsException")>=0&&(c="The query returned too many rows."),b(A.reportContainer).html(c),b(A.loading).hide()}function h(a){0===a&&(b(A.reportContainer).html("Report is empty"),b(A.loading).hide())}function i(){var a=x.pages()||1,c=x.data().totalPages;h(c),c>1?(b(A.pageCurrent).val(a),b(A.pageCount).html(" of "+c),b(A.button.first).prop("disabled",a<=1),b(A.button.previous).prop("disabled",a<=1),b(A.button.next).prop("disabled",a>=c),b(A.button.last).prop("disabled",void 0===c||a>=c),b(A.pagingbar).show()):b(A.pagingbar).hide()}function j(){var a=x.data();if(h(a.totalPages),b(A.loading).hide(),b(A.controls).show(),b([A.exportpdf,A.exportxlsx,A.emailButton].join(", ")).prop("disabled",!1),i(),f){var c=b(A.reportContainer+" table.jrPage").width();if(c>0){var d=b(A.reportContainer+" table.jrPage").height(),e=b(A.reportContainer).width();b(A.reportContainer).height(d*e/c)}}else a.components.length>0&&"chart"!==a.components[0].componentType&&(b(A.reportContainer).height(""),b(A.reportContainer).height(b(A.reportContainer).height()))}function k(){b(A.reportContainer+" > div.visualizejs").height()||b(A.loading).show()}function l(){x.run().done(j).fail(g),b(A.loadingMessage).html("Loading Report ..."),k()}function m(){b(A.button.first).click(function(){var a=x.pages()||1;a>1&&(x.pages(1),l())}),b(A.button.previous).click(function(){var a=x.pages()||1;a>1&&(x.pages(--a),l())}),b(A.button.next).click(function(){var a=x.pages()||1,b=x.data().totalPages;(void 0===b||a<b)&&(x.pages(++a),l())}),b(A.button.last).click(function(){var a=x.pages()||1,b=x.data().totalPages;b>a&&(x.pages(b),l())}),b(A.pageCurrent).change(function(){var a=parseInt(b(A.pageCurrent).val(),10),c=parseInt(x.pages())||1,d=x.data().totalPages;void 0===a||isNaN(a)||a<1?a=1:void 0!==d&&a>d&&(a=d),a!==c&&(x.pages(a),l()),b(A.pageCurrent).val(a)})}function n(){b(A.exportpdf).click(function(){x["export"]({outputFormat:"pdf"}).done(function(a){var b=a.href?a.href:a;window.open(b)}).fail(function(a){d.alert("Error",a.message,"OK")})}),b(A.exportxlsx).click(function(){x["export"]({outputFormat:"xlsx",ignorePagination:!0}).done(function(a){var b=a.href?a.href:a;window.open(b)}).fail(function(a){d.alert("Error",a.message,"OK")})})}function o(a){b("body").addClass("modal-open"),b("body").append('<div class="modal-backdrop in"></div>'),b(a).show();var c=b(a+" div.modal-header").outerHeight()||0,d=b(a+" div.modal-footer").outerHeight()||0,e=b(a+" div.modal-body").outerHeight()-b(a+" div.modal-body").height(),f=.8*window.outerHeight-c-d-e;b(a+" div.modal-body").css("max-height",f)}function p(a){b(a).hide(),b("body").removeClass("modal-open"),b("div.modal-backdrop.in").remove()}function q(){b(A.emailButton).click(function(){o("#block_zoola_reports-emailform")}),b('#block_zoola_reports-emailform input[name="cancel"]').prop("onclick","").click(function(a){a.preventDefault(),p("#block_zoola_reports-emailform")}),b("#block_zoola_reports-emailform button.close").click(function(){p("#block_zoola_reports-emailform")}),b("#block_zoola_reports-emailform form").submit(function(a){if(a.preventDefault(),!b('#block_zoola_reports-emailform input[name="to"]').val()||!b('#block_zoola_reports-emailform input[name="subject"]').val())return!1;var c=b("#block_zoola_reports-emailform form").serialize(),f={jsonformdata:JSON.stringify(c),reportparams:JSON.stringify(y.data().parameters)};b("#block_zoola_reports-emailform form").css("opacity",.3),b(".block_zoola_reports-emailwait").show();var g=e.call([{methodname:"block_zoola_reports_email_report_form",args:f,done:function(a){p("#block_zoola_reports-emailform"),d.addNotification?d.addNotification({message:a,type:"success"}):d.alert("Success",a,"OK")},fail:function(a){d.alert("Error",a.message)}}]);g[0].always(function(){b(".block_zoola_reports-emailwait").hide(),b("#block_zoola_reports-emailform form").css("opacity","")})}),b("#block_zoola_reports_email").prop("disabled",!1)}function r(){b(A.backButton).click(w.popReport)}function s(){function a(){p(A.inputControls),x.params(y.data().parameters).pages(1),l()}b(A.inputControls+" button.btn-apply").click(function(){a()}),b(A.inputControls+" button.btn-reset").click(function(){y.reset().then(function(){if(!b.isEmptyObject(B[0].defaultParams))return y.params(B[0].defaultParams).run()}).done(function(){a()})}),b(A.inputControls+" button.btn-cancel").click(function(){p(A.inputControls)}),b(A.filterButton).click(function(){o(A.inputControls)})}function t(){var a=A.reportContainer;b(a).parents("#block-region-side-pre, #block-region-side-post").length>=1?b(A.filterButton).html("&#9776;"):b(a).parents("#block-region-content").length>=1?b(A.exportpdf+", "+A.exportxlsx).show():b(A.exportpdf+", "+A.exportxlsx+", "+A.emailButton).show()}function u(){B.length>1?b(A.backButton).show():b(A.backButton).hide()}function v(c,d,e){var h=A.reportContainer;b(A.reportContainer).height(""),e?b(A.loadingMessage).html("Loading Report ..."):b(A.loadingMessage).html("Loading Filters ...");var k={resource:c,container:h,runImmediately:!1,params:d,defaultJiveUi:{enabled:!0},events:{changeTotalPages:function(){i()},reportCompleted:function(a){"ready"===a&&j()},beforeRender:function(a){b(A.loading).hide();var c=b(a).find("table.jrPage"),d=c.width();if(d>0){c.find("tr").last().height(20);var e=c.find("tr").first(),f=e.children().first().width(),g=e.children().last().width(),h=this.data().components.length,i=e.children().length;i===h+2&&g>f&&(e.children().last().width(f),c.width(d-(g-f)))}}},linkOptions:{beforeRender:function(a){a.forEach(function(a){var b=a.element,c=a.data;(c.href||"ReportExecution"===c.type)&&(b.style.cursor="pointer",b.style.textDecoration="underline")})},events:{click:function(a,b){if(b.href&&(window.open(b.href),a.stopPropagation()),"ReportExecution"===b.type){B[0].currentParams=y.data().parameters;var c,d={};Object.keys(b.parameters).forEach(function(a){"_report"===a?c=b.parameters[a]:d[a]=[b.parameters[a]]}),w.pushReport(c,d,!0)}}}}};f&&(k.scale="width"),x=a.report(k),y=a.inputControls({resource:c,container:A.filtersBody,params:d,error:function(a){b(A.filtersBody).html(a.message),g(a)},success:function(a){a.length>0?(b(A.filterButton).prop("disabled",!1),e||(o(A.inputControls),b(A.loading).hide())):(b(A.filterButton).prop({disabled:!0,title:"The report does not have filters"}),b(A.filtersBody).html("The report does not have filters"),e||l())}}),e&&l()}var w=this,x=null,y=null,z="#block_zoola_reports-"+c,A={reportContainer:z+" > div.block_zoola_reports_report",controls:z+" > div.block_zoola_reports_controls",inputControls:z+" > div.block_zoola_reports_inputcontrols",pagingbar:z+" div.block_zoola_reports_pagingbar",button:{first:z+" div.block_zoola_reports_pagingbar > button.block_zoola_reports_first",previous:z+" div.block_zoola_reports_pagingbar > button.block_zoola_reports_previous",next:z+" div.block_zoola_reports_pagingbar > button.block_zoola_reports_next",last:z+" div.block_zoola_reports_pagingbar > button.block_zoola_reports_last"},pageCurrent:z+" div.block_zoola_reports_pagingbar > input.block_zoola_reports_pagecurrent",pageCount:z+" div.block_zoola_reports_pagingbar > span.block_zoola_reports_pagecount",emptyReport:z+" div.emptyreport",loading:z+" div.block_zoola_reports_loading",loadingMessage:z+" div.block_zoola_reports_loading span.message",exportpdf:z+" button.block_zoola_reports_exportpdf",exportxlsx:z+" button.block_zoola_reports_exportxlsx",backButton:z+" button.block_zoola_reports_back",filterButton:z+" button.block_zoola_reports_showfilters",filtersBody:z+" div.modal-body",emailButton:z+" button.block_zoola_reports_email"},B=[];this.setControls=function(){b(A.controls).show(),m(),t(),n(),q(),s(),r()},this.popReport=function(){B.shift();var a=B[0];u(),v(a.reportUri,a.currentParams,!0)},this.pushReport=function(a,b,c){B.unshift({reportUri:a,currentParams:{},defaultParams:b}),u(),v(a,b,c)}};return{embedReport:function(a,d,e,g,h,i,j){c(["block_zoola_reports/visualize"],function(c){c.getVisualize(a,d).done(function(a){var b=new f(a,e,h);b.setControls(),b.pushReport(g,j,i)}).fail(function(a){b("#block_zoola_reports-"+e).html(a.message)})})}}});